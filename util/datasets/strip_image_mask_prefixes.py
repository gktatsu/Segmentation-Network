#!/usr/bin/env python3
"""
Recursively strip 'image_' / 'mask_' substrings from PNG filenames.
Useful for preparing datasets generated by ControlNet where files are prefixed with these strings.
"""
from __future__ import annotations

import argparse
import os
from pathlib import Path
from typing import Iterable

TARGET_SUBSTRINGS = ("image_", "mask_")
TARGET_EXTENSIONS = {".png"}


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description=(
            "Recursively traverse a root directory and remove 'image_' and/"
            "or 'mask_' substrings from PNG filenames."
        )
    )
    parser.add_argument(
        "root",
        help="Root directory to scan recursively",
    )
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Show rename plan without touching files",
    )
    parser.add_argument(
        "--overwrite",
        action="store_true",
        help=(
            "Allow overwriting files when the destination name already "
            "exists"
        ),
    )
    return parser.parse_args()


def should_process(path: Path) -> bool:
    return path.is_file() and path.suffix.lower() in TARGET_EXTENSIONS


def compute_new_name(name: str, substrings: Iterable[str]) -> str:
    new_name = name
    for substring in substrings:
        new_name = new_name.replace(substring, "")
    return new_name


def rename_file(
    path: Path,
    new_name: str,
    *,
    dry_run: bool,
    overwrite: bool,
) -> bool:
    if path.name == new_name:
        return False
    target = path.with_name(new_name)
    if target.exists() and not overwrite:
        print(
            f"[SKIP] {target} already exists. Use --overwrite to replace it."
        )
        return False
    if dry_run:
        print(f"[DRY-RUN] {path} -> {target}")
        return True
    target.parent.mkdir(parents=True, exist_ok=True)
    if target.exists() and overwrite:
        target.unlink()
    path.rename(target)
    print(f"[RENAMED] {path.name} -> {target.name}")
    return True


def main() -> int:
    args = parse_args()
    root = Path(args.root).expanduser().resolve()
    if not root.is_dir():
        print(f"Error: '{root}' is not a directory")
        return 1

    processed_dirs = 0
    renamed_files = 0

    for dirpath, _dirnames, filenames in os.walk(root):
        processed_dirs += 1
        directory = Path(dirpath)
        for filename in filenames:
            path = directory / filename
            if not should_process(path):
                continue
            new_name = compute_new_name(path.name, TARGET_SUBSTRINGS)
            changed = rename_file(
                path,
                new_name,
                dry_run=args.dry_run,
                overwrite=args.overwrite,
            )
            if changed:
                renamed_files += 1

    print(
        f"Completed scanning {processed_dirs} directories. "
        f"Renamed {renamed_files} file(s)."
    )
    if args.dry_run:
        print("(Dry-run: no files were modified.)")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
